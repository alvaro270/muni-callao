<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Datos del Beneficiario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0B42A0',
            secondary: '#10B099'
          }
        }
      }
    };
  </script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-3xl bg-white shadow-lg rounded-xl p-6 space-y-6 border-t-4 border-primary">
    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 flex items-center space-x-2">
      <span>ðŸ‘¤</span><span>Datos del Beneficiario</span>
    </h2>

    <!-- Campo: Nombre -->
    <div class="flex flex-col md:flex-row items-start gap-2">
      <label class="w-40 font-medium text-gray-700">Nombre Completo: <span class="text-red-500">*</span></label>
      <input type="text" placeholder="[Ingrese nombre completo]"
             class="flex-1 w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary text-sm" />
    </div>

    <!-- Campo: DNI -->
    <div class="flex flex-col md:flex-row items-start gap-2">
      <label class="w-40 font-medium text-gray-700">DNI: <span class="text-red-500">*</span></label>
      <input type="text" placeholder="[12345678]" maxlength="8"
             class="flex-1 w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary text-sm" />
    </div>

    <!-- Campo: Comedor -->
    <div class="flex flex-col md:flex-row items-start gap-2">
      <label class="w-40 font-medium text-gray-700">Comedor: <span class="text-red-500">*</span></label>
      <select id="comedorSelect" class="flex-1 w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary text-sm text-gray-600">
        <option disabled selected>Seleccionar Comedor...</option>
      </select>
    </div>

    <!-- Campo: Estado -->
    <div class="flex flex-col md:flex-row items-start gap-2">
      <label class="w-40 font-medium text-gray-700">Estado:</label>
      <input type="text" value="Activo" readonly
             class="flex-1 w-full border border-gray-200 bg-gray-100 rounded-lg px-4 py-2 text-green-600 font-medium text-sm" />
    </div>

    <!-- Botones -->
    <div class="flex justify-end space-x-4 pt-4 border-t mt-6">
      <button id="cancelarBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-5 py-2 rounded-lg text-sm font-medium">Cancelar</button>
      <button id="guardarBtn" class="bg-primary hover:bg-blue-800 text-white px-5 py-2 rounded-lg text-sm font-medium">Guardar</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const comedorSelect = document.getElementById("comedorSelect");
      const guardarBtn = document.getElementById("guardarBtn");
      const cancelarBtn = document.getElementById("cancelarBtn");
      const nombreInput = document.querySelector("input[placeholder='[Ingrese nombre completo]']");
      const dniInput = document.querySelector("input[placeholder='[12345678]']");
      const estadoInput = document.querySelector("input[value='Activo']");

      // FunciÃ³n para cargar comedores activos en el select
      function cargarComedores() {
        try {
          const comedoresStorage = localStorage.getItem("comedores");
          
          if (comedoresStorage) {
            const comedores = JSON.parse(comedoresStorage);
            
            // Limpiar opciones existentes (excepto la primera)
            comedorSelect.innerHTML = '<option disabled selected>Seleccionar Comedor...</option>';
            
            // Filtrar solo comedores activos y agregarlos al select
            comedores
              .filter(comedor => comedor.estado === "Activo")
              .forEach(comedor => {
                const option = document.createElement("option");
                option.value = comedor.id;
                option.textContent = `${comedor.nombre} - ${comedor.direccion}`;
                option.dataset.nombre = comedor.nombre;
                comedorSelect.appendChild(option);
              });
          } else {
            console.log("No se encontraron comedores en localStorage");
          }
        } catch (error) {
          console.error("Error al cargar comedores:", error);
          alert("Error al cargar los comedores. Verifica los datos.");
        }
      }

      // FunciÃ³n para limpiar el formulario
      function limpiarFormulario() {
        nombreInput.value = "";
        dniInput.value = "";
        comedorSelect.selectedIndex = 0;
      }

      // FunciÃ³n para validar DNI (solo nÃºmeros)
      function validarDNI(dni) {
        return /^\d{8}$/.test(dni);
      }

      // Cargar comedores al iniciar
      cargarComedores();

      // ValidaciÃ³n en tiempo real del DNI
      dniInput.addEventListener("input", (e) => {
        // Solo permitir nÃºmeros
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });

      // Evento para guardar beneficiario
      guardarBtn.addEventListener("click", () => {
        const nombre = nombreInput.value.trim();
        const dni = dniInput.value.trim();
        const comedorId = comedorSelect.value;
        const comedorNombre = comedorSelect.options[comedorSelect.selectedIndex]?.dataset.nombre;
        const estado = estadoInput.value;

        // Validaciones
        if (!nombre) {
          alert("Por favor ingresa el nombre completo.");
          nombreInput.focus();
          return;
        }

        if (!validarDNI(dni)) {
          alert("Por favor ingresa un DNI vÃ¡lido de 8 dÃ­gitos.");
          dniInput.focus();
          return;
        }

        if (!comedorId || comedorId === "Seleccionar Comedor...") {
          alert("Por favor selecciona un comedor.");
          comedorSelect.focus();
          return;
        }

        try {
          // Crear objeto beneficiario
          const nuevoBeneficiario = {
            nombre: nombre,
            dni: dni,
            comedor: {
              id: parseInt(comedorId),
              nombre: comedorNombre
            },
            estado: estado,
            fechaRegistro: new Date().toISOString()
          };

          // Obtener beneficiarios existentes
          const beneficiarios = JSON.parse(localStorage.getItem("beneficiarios")) || [];

          // Verificar si ya existe un beneficiario con ese DNI
          const yaExiste = beneficiarios.some(b => b.dni === dni);
          if (yaExiste) {
            alert("Ya existe un beneficiario registrado con ese DNI.");
            dniInput.focus();
            return;
          }

          // Agregar nuevo beneficiario
          beneficiarios.push(nuevoBeneficiario);
          localStorage.setItem("beneficiarios", JSON.stringify(beneficiarios));

          alert("âœ… Beneficiario guardado correctamente.");
          console.log("Beneficiario guardado:", nuevoBeneficiario);

          // Limpiar formulario
          limpiarFormulario();

        } catch (error) {
          console.error("Error al guardar beneficiario:", error);
          alert("Error al guardar el beneficiario. Intenta nuevamente.");
        }
      });

      // Evento para cancelar
      cancelarBtn.addEventListener("click", () => {
        if (nombreInput.value || dniInput.value || comedorSelect.selectedIndex > 0) {
          if (confirm("Â¿EstÃ¡s seguro de que deseas cancelar? Se perderÃ¡n los datos ingresados.")) {
            limpiarFormulario();
          }
        }
      });

      // Agregar evento para recargar comedores si se actualizan
      window.addEventListener("storage", (e) => {
        if (e.key === "comedores") {
          cargarComedores();
        }
      });
    });
  </script>
</body>
</html>